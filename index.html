<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HWM Pegasus - Master V14 (Tubings Visibles)</title>
    <style>
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #0d0d0d;
            color: #eee;
            margin: 0;
            padding: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            touch-action: none;
        }

        h3 {
            margin: 2px 0;
            color: #4fc3f7;
            font-size: 0.9rem;
            text-align: center;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* --- ZONA 1: ESQUEMA --- */
        .canvas-wrapper {
            flex-grow: 1;
            width: 100%;
            max-width: 450px;
            background: #181818;
            border-radius: 12px;
            border: 1px solid #333;
            margin-bottom: 5px;
            position: relative;
            overflow: hidden;
            display: flex;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .time-widget {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            color: #fff;
            pointer-events: none;
        }

        .alerts-layer {
            position: absolute;
            top: 40px;
            left: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            pointer-events: none;
            z-index: 10;
        }

        .alert-tag {
            padding: 6px 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.75rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.8);
            display: none;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .al-warn {
            background: rgba(255, 143, 0, 0.95);
            color: black;
            border: 1px solid #ffb300;
        }

        .al-crit {
            background: rgba(213, 0, 249, 0.95);
            color: white;
            border: 2px solid #ea80fc;
            animation: pulse 0.8s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        /* --- ZONA 2: CONTROLES --- */
        .controls-panel {
            width: 100%;
            max-width: 450px;
            flex-shrink: 0;
            background: #262626;
            padding: 8px;
            border-radius: 12px;
            border-top: 2px solid #0277bd;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 5px;
            z-index: 50;
            transition: background 0.3s;
        }

        .controls-panel.overlay-mode {
            position: absolute;
            bottom: 10px;
            background: rgba(38, 38, 38, 0.9);
            border: 1px solid #555;
            backdrop-filter: blur(5px);
        }

        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info-col {
            display: flex;
            flex-direction: column;
            width: 35%;
        }

        label {
            font-size: 0.6rem;
            color: #bbb;
            font-weight: bold;
            text-transform: uppercase;
        }

        .digital-val {
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            color: #fff;
            font-weight: bold;
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 5px;
            width: 65%;
        }

        input[type=range] {
            flex-grow: 1;
            height: 25px;
            accent-color: #0288d1;
            cursor: pointer;
        }

        .btn-adj {
            width: 30px;
            height: 30px;
            background: #333;
            border: 1px solid #555;
            border-radius: 6px;
            color: #fff;
            font-weight: bold;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            touch-action: manipulation;
        }

        .btn-adj:active {
            background: #0288d1;
            border-color: #0288d1;
        }

        .btn-adj:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-fail {
            background: #333;
            color: #aaa;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.8rem;
            text-transform: uppercase;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            gap: 5px;
        }

        .btn-fail.active {
            background: #b71c1c;
            color: white;
            border-color: #ff5252;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 18px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #00E676;
        }

        input:checked+.slider:before {
            transform: translateX(16px);
        }

        /* --- ZONA 3: LOGGER --- */
        .logger-panel {
            width: 100%;
            max-width: 450px;
            flex-shrink: 0;
            background: #000;
            border: 1px solid #444;
            border-radius: 8px;
            height: 120px;
            position: relative;
            transition: all 0.3s ease;
        }

        .logger-panel.expanded {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            max-width: none;
            z-index: 100;
            border-radius: 0;
            border: none;
        }

        .logger-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .logger-legend {
            position: absolute;
            top: 4px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            font-size: 0.75rem;
            font-family: monospace;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.7);
            padding: 4px 10px;
            white-space: nowrap;
            pointer-events: none;
            z-index: 20;
        }

        .btn-expand {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #333;
            color: white;
            border: 1px solid #555;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }

        .l-val {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dot-g {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .val-num {
            color: #fff;
            font-weight: normal;
        }

        .legend-bar {
            display: flex;
            justify-content: center;
            gap: 10px;
            font-size: 0.6rem;
            color: #888;
            margin-bottom: 2px;
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 3px;
        }
    </style>
</head>

<body>
    <h3 id="appTitle">HWM Pegasus Mobile V14 (Tubings Visibles)</h3>
    <div class="canvas-wrapper" id="schematicWrapper">
        <canvas id="simCanvas"></canvas>
        <div class="time-widget">
            <span id="dayIcon">‚òÄÔ∏è</span> <span id="clock">12:00</span>
        </div>
        <div class="alerts-layer">
            <div id="alCrit" class="alert-tag al-crit">‚õî CORTE AUTOM√ÅTICO (&lt;10m)</div>
            <div id="alHigh" class="alert-tag al-warn">‚ö†Ô∏è SET POINT ALTO</div>
            <div id="alLowBat" class="alert-tag al-warn">üîã BATER√çA BAJA (5%)</div>
        </div>
    </div>
    <div class="controls-panel" id="controlsPanel">
        <div class="legend-bar">
            <span><span class="dot" style="background:#ff1744"></span>Pin (m)</span>
            <span><span class="dot" style="background:#2979ff"></span>Pout (m)</span>
            <span><span class="dot" style="background:#00E676"></span>Q (m¬≥/h)</span>
        </div>
        <div class="control-row">
            <div class="info-col"><label>Aguas Arriba (PIn)</label>
                <div class="digital-val"><span id="txtIn">60</span>m</div>
            </div>
            <div class="slider-group">
                <button class="btn-adj" id="btnInDec" data-dir="-1">-</button>
                <input type="range" id="sliderIn" min="0" max="100" value="60">
                <button class="btn-adj" id="btnInInc" data-dir="1">+</button>
            </div>
        </div>
        <div class="control-row">
            <div class="info-col"><label style="color:#81d4fa">Set Point (POut)</label>
                <div class="digital-val" style="color:#81d4fa"><span id="txtTarget">25</span>m</div>
            </div>
            <div class="slider-group">
                <button class="btn-adj" id="btnTgtDec" data-dir="-1">-</button>
                <input type="range" id="sliderTarget" min="0" max="100" value="25">
                <button class="btn-adj" id="btnTgtInc" data-dir="1">+</button>
            </div>
        </div>

        <div class="control-row" style="margin-top:5px; border-top:1px solid #444; padding-top:5px;">
            <button id="btnObstruction" class="btn-fail" style="flex:1; margin-right:10px;"><span>ü™®
                    Obstrucci√≥n</span></button>
            <div style="display:flex; align-items:center; gap:8px;">
                <label style="cursor:pointer; font-size:0.7rem; color:#00E676" for="chkSim">Sim 24h</label>
                <label class="switch"><input type="checkbox" id="chkSim"><span class="slider"></span></label>
            </div>
        </div>
        <div style="display:flex; gap:5px; margin-top:5px;">
            <button id="btnFailClose" class="btn-fail" style="flex:1">‚õî Falla Cierre</button>
            <button id="btnFailOpen" class="btn-fail" style="flex:1">‚õî Falla Apertura</button>
        </div>
    </div>
    <div id="loggerPanel" class="logger-panel">
        <button class="btn-expand" id="btnExpand">‚§¢</button>
        <canvas id="chartCanvas" class="logger-canvas"></canvas>
        <div class="logger-legend">
            <div class="l-val" style="color:#ff1744">
                <span class="dot-g" style="background:#ff1744"></span>Pin: <span id="valPin" class="val-num">60</span>m
            </div>
            <div class="l-val" style="color:#2979ff">
                <span class="dot-g" style="background:#2979ff"></span>Pout: <span id="valPout"
                    class="val-num">25</span>m
            </div>
            <div class="l-val" style="color:#00E676">
                <span class="dot-g" style="background:#00E676"></span>Q: <span id="valFlow"
                    class="val-num">850</span>m¬≥/h
            </div>
        </div>
    </div>

    <script>
        // --- Referencias DOM ---
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const wrapper = document.getElementById('schematicWrapper');
        const cChart = document.getElementById('chartCanvas');
        const ctxChart = cChart.getContext('2d');
        const loggerPanel = document.getElementById('loggerPanel');
        const controlsPanel = document.getElementById('controlsPanel');
        const appTitle = document.getElementById('appTitle');

        const valPin = document.getElementById('valPin');
        const valPout = document.getElementById('valPout');
        const valFlow = document.getElementById('valFlow');
        const sIn = document.getElementById('sliderIn');
        const sTarget = document.getElementById('sliderTarget');
        const txtIn = document.getElementById('txtIn');
        const txtTarget = document.getElementById('txtTarget');

        const btnObs = document.getElementById('btnObstruction');
        const btnFailClose = document.getElementById('btnFailClose');
        const btnFailOpen = document.getElementById('btnFailOpen');
        const chkSim = document.getElementById('chkSim');
        const btnExpand = document.getElementById('btnExpand');
        const alCrit = document.getElementById('alCrit');
        const alHigh = document.getElementById('alHigh');
        const alLowBat = document.getElementById('alLowBat');
        const dayIcon = document.getElementById('dayIcon');
        const clock = document.getElementById('clock');

        // --- Estado del Sistema ---
        const sys = {
            pIn: 60, pTarget: 25, pOut: 25,
            valvePos: 0.5,
            action: 'hold',
            headLoss: 5,
            obstruction: false,
            failClose: false,
            failOpen: false,
            anim: 0,
            emergencyMode: false,
            simFlow: 0,
            isSimulating: false,
            simHour: 12.0,
            batteryLevel: 95, // Nivel de bater√≠a (0-100)
            commSignal: 4, // Nivel de se√±al (0-5)
            // Ruido Fijo en 25m de amplitud
            FIXED_NOISE_AMPLITUDE: 25,

            // Historial para el gr√°fico
            histIn: new Array(1200).fill(60),
            histOut: new Array(1200).fill(25),
            histFlow: new Array(1200).fill(850),

            isExpanded: false,
            // Par√°metros de control PI
            Kp: 0.05, // Ganancia Proporcional
            Ki: 0.001, // Ganancia Integral
            integralError: 0,
            prevError: 0,
            timeStep: 1, // Simulaci√≥n por segundo (1Hz)
        };

        // --- Variables de Dibujo ---
        let scale = 1;
        const logicW = 360;
        let logicH = 500;
        let particles = Array.from({
            length: 80
        }, () => ({
            x: Math.random() * 360,
            y: 0
        }));
        let spray = [];

        // --- Funciones de Utilidad ---

        function resize() {
            if (wrapper.style.display !== 'none') {
                const r = wrapper.getBoundingClientRect();
                canvas.width = r.width;
                canvas.height = r.height;
                scale = r.width / logicW;
                ctx.scale(scale, scale);
                logicH = r.height / scale;
            }
            const rc = loggerPanel.getBoundingClientRect();
            cChart.width = rc.width;
            cChart.height = rc.height;
        }

        function updateControlsState() {
            // Se deshabilita Pin/Ptarget en modo simulaci√≥n o por bater√≠a baja.
            let st = sys.isSimulating || sys.batteryLevel < 5;
            sIn.disabled = st;
            sTarget.disabled = st;

            document.querySelectorAll('.control-row .btn-adj').forEach(btn => btn.disabled = st);
        }

        function changeVal(slider, txtElement, sysVar, delta) {
            if (sys.isSimulating || sys.batteryLevel < 5) return;

            let v = parseFloat(slider.value) + delta;
            v = Math.round(v);

            if (v < 0) v = 0;
            if (v > 100) v = 100;

            slider.value = v;
            sys[sysVar] = v;
            txtElement.innerText = v;
        }

        // --- Manejo de Eventos (Botones y Sliders) ---
        sIn.oninput = (e) => {
            if (!sys.isSimulating && sys.batteryLevel >= 5) {
                sys.pIn = parseFloat(e.target.value);
                txtIn.innerText = Math.round(sys.pIn);
            }
        };
        sTarget.oninput = (e) => {
            if (!sys.isSimulating && sys.batteryLevel >= 5) {
                sys.pTarget = parseFloat(e.target.value);
                txtTarget.innerText = Math.round(sys.pTarget);
            }
        };

        const txtElement =
            document.getElementById(`txt${sysVar.charAt(1).toUpperCase() + sysVar.slice(2)}`) ||
            document.getElementById(`txt${sysVar.charAt(0).toUpperCase() + sysVar.slice(1)}`);

        const update = () => changeVal(slider, txtElement, sysVar, dir);

        const startPress = () => {
            if (btn.disabled) return;
            update(); // Primer cambio inmediato
            timer = setTimeout(() => {
                interval = setInterval(update, 100); // Cambios r√°pidos tras un retraso
            }, 300);
        };

        const stopPress = () => {
            clearTimeout(timer);
            clearInterval(interval);
        };

        btn.addEventListener('mousedown', startPress);
        btn.addEventListener('touchstart', startPress, {
            passive: true
        });
        btn.addEventListener('mouseup', stopPress);
        btn.addEventListener('mouseleave', stopPress);
        btn.addEventListener('touchend', stopPress);
        btn.addEventListener('touchcancel', stopPress);
        

        setupLongPress('btnInDec', 'sliderIn', 'pIn', -1);
        setupLongPress('btnInInc', 'sliderIn', 'pIn', 1);
        setupLongPress('btnTgtDec', 'sliderTarget', 'pTarget', -1);
        setupLongPress('btnTgtInc', 'sliderTarget', 'pTarget', 1);

        // --- Eventos de Fallo ---
        btnObs.onclick = () => {
            sys.obstruction = !sys.obstruction;
            btnObs.className = sys.obstruction ? "btn-fail active" : "btn-fail";
        };
        btnFailClose.onclick = () => {
            sys.failClose = !sys.failClose;
            btnFailClose.className = sys.failClose ? "btn-fail active" : "btn-fail";
        };
        btnFailOpen.onclick = () => {
            sys.failOpen = !sys.failOpen;
            btnFailOpen.className = sys.failOpen ? "btn-fail active" : "btn-fail";
        };

        // --- Evento de Simulaci√≥n ---
        chkSim.onchange = (e) => {
            sys.isSimulating = e.target.checked;
            updateControlsState();
            if (sys.isSimulating) {
                sys.simHour = 0;
            } else {
                dayIcon.innerText = "‚öôÔ∏è";
                clock.innerText = "MANUAL";
            }
            // Resetear el control PI y el historial al cambiar de modo
            sys.integralError = 0;
            sys.prevError = 0;
            sys.histIn.fill(sys.pIn);
            sys.histOut.fill(sys.pOut);
            sys.histFlow.fill(sys.simFlow);
        };

        // --- Evento de Expansi√≥n del Logger ---
        btnExpand.onclick = () => {
            sys.isExpanded = !sys.isExpanded;
            if (sys.isExpanded) {
                loggerPanel.classList.add('expanded');
                controlsPanel.classList.add('overlay-mode');
                wrapper.style.display = 'none';
                appTitle.style.display = 'none';
                btnExpand.innerText = "‚úñ";
            } else {
                loggerPanel.classList.remove('expanded');
                controlsPanel.classList.remove('overlay-mode');
                wrapper.style.display = 'flex';
                appTitle.style.display = 'block';
                btnExpand.innerText = "‚§¢";
            }
            setTimeout(resize, 50);
        };

        // Funci√≥n de Generaci√≥n de Ruido Aleatorio (Fluctuaciones)
        function generateNoise(amplitude) {
            // Genera un valor aleatorio entre -amplitude y +amplitude
            return (Math.random() - 0.5) * 2 * amplitude;
        }

        // --- L√≥gica del Sistema y Control PI ---
        function updateSystemLogic() {
            // 1. SIMULACI√ìN DE 24H (Si est√° activa)
            if (sys.isSimulating) {
                sys.simHour += 0.0166; // 1 min por frame (simulaci√≥n acelerada)
                if (sys.simHour >= 24) sys.simHour = 0;

                let h = Math.floor(sys.simHour);
                let m = Math.floor((sys.simHour - h) * 60);

                clock.innerText = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                dayIcon.innerText = (sys.simHour >= 6 && sys.simHour < 19) ? "‚òÄÔ∏è" : "üåô";
            }
        }
        // Perfil de Pin (mayor en la noche, menor en el d√≠a)
        let baseIn;

        if (sys.simHour < 6 || sys.simHour > 22) {
            baseIn = 80; // Noche (PIn alta)
        } else if (sys.simHour >= 6 && sys.simHour < 8) {
            baseIn = 80 - ((sys.simHour - 6) * 20); // Amanecer (ca√≠da)
        } else if (sys.simHour >= 20 && sys.simHour < 22) {
            baseIn = 40 + ((sys.simHour - 20) * 20); // Anochecer (subida)
        } else {
            baseIn = 40; // D√≠a (PIn baja)
        }

        // Aplicar el ruido fijo (25m de amplitud)
        let targetIn = baseIn + generateNoise(sys.FIXED_NOISE_AMPLITUDE);

        // Perfil de Set Point (mayor en el d√≠a)
        let targetSet = 8;
        if (sys.simHour >= 6 && sys.simHour < 21) {
            if (sys.simHour < 9) targetSet = 8 + ((sys.simHour - 6) / 3) * 14;
            else targetSet = 22;
        } else {
            if (sys.simHour >= 21 && sys.simHour < 22) targetSet = 22 - ((sys.simHour - 21) * 14);
            else targetSet = 8;
        }

        // La Pin real se acerca al objetivo aleatorio (con suavizado)
        sys.pIn += (targetIn - sys.pIn) * 0.1;
        sys.pTarget = targetSet;

        // Restricciones de Pin (0 a 100)
        if (sys.pIn < 0) sys.pIn = 0;
        if (sys.pIn > 100) sys.pIn = 100;

        sIn.value = sys.pIn;
        sTarget.value = sys.pTarget;
        txtIn.innerText = Math.round(sys.pIn);
        txtTarget.innerText = Math.round(sys.pTarget);

        if (sys.isSimulating) {
            sys.batteryLevel -= 0.005;
        } else {
            sys.batteryLevel -= 0.001;
        }

        // M√≠nimo de bater√≠a
        if (sys.batteryLevel < 0) sys.batteryLevel = 0;

        // 2. MODULACI√ìN DE V√ÅLVULA (Control PI)
        const maxPhy = Math.max(0, sys.pIn - sys.headLoss);
        sys.emergencyMode = sys.pIn < 10;
        const lowBattery = sys.batteryLevel < 5;

        // Alertas
        alCrit.style.display = sys.emergencyMode ? 'block' : 'none';
        alHigh.style.display = (sys.pTarget > maxPhy) ? 'block' : 'none';
        alLowBat.style.display = lowBattery ? 'block' : 'none';

        // Si la bater√≠a es baja o emergencia, el sistema se detiene
        if (lowBattery || sys.emergencyMode) {
            sys.action = 'hold';
            sys.integralError = 0;
            updateControlsState();
        } else {
            updateControlsState();
            const error = sys.pTarget - sys.pOut;

            // C√≥mputo del control PI
            sys.integralError += error * sys.timeStep;

            // Anti-windup 
            const integralLimit = 50;
            if (sys.integralError > integralLimit) sys.integralError = integralLimit;
            if (sys.integralError < -integralLimit) sys.integralError = -integralLimit;

            let output = (sys.Kp * error) + (sys.Ki * sys.integralError);

            // Control de velocidad de la v√°lvula (ajustar sensibilidad)
            const maxValveSpeed = 0.02;
            if (output > maxValveSpeed) output = maxValveSpeed;
            if (output < -maxValveSpeed) output = -maxValveSpeed;

            // Aplicar Fallos
            if ((output < 0 && sys.failClose) || (output > 0 && sys.failOpen)) {
                sys.action = 'hold';
            } else {
                sys.valvePos += output;
                sys.action = output > 0.001 ? 'open' : (output < -0.001 ? 'close' : 'hold');
            }
        }


        // L√≠mites f√≠sicos de la v√°lvula (0 a 1)
        let limitMin = sys.obstruction ? 0.7 : 0.0;
        if (sys.valvePos < limitMin) sys.valvePos = limitMin;
        if (sys.valvePos > 1.0) sys.valvePos = 1.0;

        // 3. C√ÅLCULO DE PRESI√ìN DE SALIDA (POut) Y CAUDAL (Q)
        let flowP = sys.pIn * sys.valvePos;
        if (flowP > maxPhy) flowP = maxPhy;

        sys.pOut += (flowP - sys.pOut) * 0.1;
        if (sys.pOut < 0) sys.pOut = 0;

        sys.simFlow = Math.floor(sys.valvePos * 1235 * (sys.pIn / 100));
        if (sys.pIn < 5) sys.simFlow = 0;

        // 4. ACTUALIZAR VALORES EN PANTALLA
        valPin.innerText = Math.round(sys.pIn);
        valPout.innerText = Math.round(sys.pOut);
        valFlow.innerText = sys.simFlow;

        // 5. REGISTRO EN EL HISTORIAL
        sys.histIn.push(sys.pIn);
        sys.histIn.shift();
        sys.histOut.push(sys.pOut);
        sys.histOut.shift();
        sys.histFlow.push(sys.simFlow);
        sys.histFlow.shift();

        // 6. ANIMACI√ìN de las micro-part√≠culas (spray)
        if (sys.action === 'open' && !sys.failOpen) {
            spray.push({
                x: 345,
                y: 120,
                vx: (Math.random() + 1) * 2,
                vy: Math.random() * 2 + 1,
                life: 1
            });
        }
        for (let i = spray.length - 1; i >= 0; i--) {
            spray[i].x += spray[i].vx;
            spray[i].y += spray[i].vy;
            spray[i].life -= 0.06;
            if (spray[i].life <= 0) spray.splice(i, 1);
        }


        // --- Funciones de Dibujo (Diagramas) ---

        function drawTimeline() {
            const w = cChart.width;
            const h = cChart.height;
            const cx = ctxChart;

            cx.clearRect(0, 0, w, h);

            const pL = 30;
            const pR = 40;
            const pB = 20;
            const pT = 20;
            const gW = w - pL - pR;
            const gH = h - pB - pT;

            // Dibujar rejilla y etiquetas de P (Izquierda)
            cx.strokeStyle = "#333";
            cx.lineWidth = 1;
            cx.fillStyle = "#888";
            cx.font = "9px sans-serif";
            cx.beginPath();
            // Eje X (Tiempo/Simulaci√≥n)
            for (let i = 0; i <= 24; i += 6) {
                let x = pL + (i / 24) * gW;
                cx.moveTo(x, pT);
                cx.lineTo(x, pT + gH);
                cx.fillText(i, x - 3, h - 5);
            }
            // Eje Y (Presi√≥n)
            cx.textAlign = "right";
            for (let i = 0; i <= 100; i += 25) {
                let y = pT + gH - (i / 100) * gH;
                cx.moveTo(pL, y);
                cx.lineTo(pL + gW, y);
                cx.fillText(i + "m", pL - 2, y + 3);
            }
            cx.stroke();

            // Etiquetas Q (Derecha)
            cx.textAlign = "left";
            cx.fillStyle = "#00E676";
            for (let i = 0; i <= 1250; i += 312) {
                let y = pT + gH - (i / 1250) * gH;
                cx.fillText(Math.round(i), w - pR + 2, y + 3);
            }
            cx.font = "8px sans-serif";
            cx.fillText("m¬≥/h", w - pR + 2, pT - 2);

            // Dibujar l√≠nea de Set Point (P Target)
            cx.strokeStyle = "#81d4fa";
            cx.lineWidth = 1;
            cx.setLineDash([5, 5]);
            let targetY = pT + gH - ((sys.pTarget / 100) * gH);
            cx.beginPath();
            cx.moveTo(pL, targetY);
            cx.lineTo(pL + gW, targetY);
            cx.stroke();
            cx.setLineDash([]);


            // Dibujar las curvas de datos
            const drawLine = (data, color, maxVal) => {
                cx.strokeStyle = color;
                cx.lineWidth = 2;
                cx.beginPath();
                let step = gW / data.length;
                for (let i = 0; i < data.length; i++) {
                    let val = data[i];
                    if (val < 0) val = 0;
                    if (val > maxVal) val = maxVal;
                    let x = pL + (i * step);
                    let y = pT + gH - ((val / maxVal) * gH);
                    if (i === 0) cx.moveTo(x, y);
                    else cx.lineTo(x, y);
                }
                cx.stroke();
            };

            drawLine(sys.histFlow, "#00E676", 1250);
            drawLine(sys.histIn, "#ff1744", 100);
            drawLine(sys.histOut, "#2979ff", 100);
        }

        function drawSchematic() {
            if (sys.isExpanded) return;

            ctx.save();
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.restore();

            // COORDENADAS AJUSTADAS PARA VISIBILIDAD
            const modY = 60;
            const valveY = 220; // Nueva posici√≥n de la tuber√≠a/v√°lvula
            const cx = 180;
            const solX = 270;
            const solY = modY;
            const ctrlX = 110;
            const ctrlY = modY - 10;
            const batX = 20;

            ctx.lineWidth = 3;
            ctx.lineJoin = "round";

            // Tuber√≠a Principal y V√°lvula
            const pipeH = 80;

            // Presi√≥n de Entrada (Color rojo-azulado, intensidad seg√∫n PIn)
            let cIn = Math.min(255, 50 + sys.pIn * 2);
            ctx.fillStyle = `rgb(${cIn}, 50, 50)`;
            ctx.fillRect(0, valveY, 360, pipeH);

            // Presi√≥n de Salida (Color azul, intensidad seg√∫n POut)
            let cOut = Math.min(255, 50 + sys.pOut * 2);
            ctx.fillStyle = `rgb(50, 100, ${cOut})`;
            ctx.fillRect(cx + 40, valveY, 360 - (cx + 40), pipeH);

            ctx.strokeStyle = "#555";
            ctx.lineWidth = 5;
            ctx.strokeRect(0, valveY, 360, pipeH);

            // Cuerpo de la V√°lvula (Diafragma/Actuador)
            ctx.fillStyle = "#333";
            ctx.beginPath();
            ctx.moveTo(cx - 40, valveY);
            ctx.lineTo(cx - 40, valveY + 40);
            ctx.lineTo(cx + 40, valveY + 40);
            ctx.lineTo(cx + 40, valveY);
            ctx.lineTo(cx + 50, valveY - 40);
            ctx.arc(cx, valveY - 40, 50, Math.PI, 0);
            ctx.lineTo(cx - 40, valveY);
            ctx.fill();
            ctx.stroke();

            // S√≠mbolo de la V√°lvula de Control (Verde, posici√≥n)
            const closedY = valveY + 40;
            const currentY = closedY - (sys.valvePos * 40); // Posici√≥n 0.0=closedY, 1.0=closedY-40

            ctx.save();
            ctx.beginPath();
            ctx.arc(cx, valveY - 40, 50, Math.PI, 0);
            ctx.lineTo(cx + 50, currentY);
            ctx.lineTo(cx - 50, currentY);
            ctx.closePath();
            ctx.clip();
            ctx.fillStyle = "rgba(0, 230, 118, 0.5)";
            ctx.fill();
            ctx.restore();

            // Obstrucci√≥n
            if (sys.obstruction) {
                ctx.fillStyle = "#8d6e63";
                ctx.beginPath();
                ctx.moveTo(cx - 20, closedY);
                ctx.lineTo(cx - 10, closedY - 15);
                ctx.lineTo(cx + 10, closedY - 10);
                ctx.lineTo(cx + 25, closedY);
                ctx.fill();
                ctx.fillStyle = "#ff5252";
                ctx.font = "bold 10px Arial";
                ctx.fillText("OBSTR.", cx + 15, closedY - 15);
            }

            // V√°stago y Diafragma
            ctx.fillStyle = "#d32f2f";
            ctx.fillRect(cx - 6, currentY, 12, (closedY + 20) - currentY); // V√°stago
            ctx.fillStyle = "#111";
            ctx.beginPath();
            ctx.ellipse(cx, currentY, 40, 8, 0, 0, 6.28);
            ctx.fill(); // Diafragma

            drawSpring(cx, valveY - 70, currentY - 5);

            // FITINGS DE PRESI√ìN EN LA TUBER√çA (NUEVA POSICI√ìN INFERIOR)
            const fittingY = valveY + pipeH / 2;

            drawFitting(15, fittingY, "#ff1744"); // Pin supply (left)
            drawFitting(330, fittingY, "#2979ff"); // Pout supply (right)
            drawFitting(190, valveY - 50, "#00E676"); // Conexi√≥n a la c√°mara

            // Mangueras Piloto y El√©ctricas (Ahora pasan por encima/lejos de la v√°lvula)

            // Manguera Pin (Aguas Arriba) a Sensor (M√≥dulo Pegasus)
            ctx.strokeStyle = "#ff1744";
            ctx.beginPath();
            ctx.moveTo(15, fittingY);
            ctx.lineTo(15, ctrlY + 100);
            ctx.lineTo(135, ctrlY + 100);
            ctx.lineTo(135, ctrlY + 70);
            ctx.stroke();

            // Manguera Pout (Aguas Abajo) a Sensor (M√≥dulo Pegasus)
            ctx.strokeStyle = "#2979ff";
            ctx.beginPath();
            ctx.moveTo(330, fittingY);
            ctx.lineTo(330, ctrlY + 100);
            ctx.lineTo(195, ctrlY + 100);
            ctx.lineTo(195, ctrlY + 70);
            ctx.stroke();

            // Manguera de Presi√≥n de Suministro para Solenoides (desde Pin)
            ctx.strokeStyle = "#ff1744";
            ctx.beginPath();
            ctx.moveTo(15, fittingY); // Sale de Pin
            ctx.lineTo(15, 10);
            ctx.lineTo(260, 10);
            ctx.lineTo(260, solY + 25);
            ctx.lineTo(solX, solY + 25);
            ctx.stroke();

            // Manguera de Control de C√°mara (a Solenoides)
            ctx.strokeStyle = "#00E676"; // P Control
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(300, solY + 50);
            ctx.lineTo(300, valveY - 60);
            ctx.lineTo(190, valveY - 60);
            ctx.lineTo(190, valveY - 50);
            ctx.stroke();

            // Dibujo de flujo de control (l√≠neas punteadas)
            if (sys.action !== 'hold') {
                sys.anim += 2;
                ctx.setLineDash([5, 10]);
                // La acci√≥n ocurre en el tramo de control de c√°mara (Verde)
                ctx.lineDashOffset = sys.action === 'close' ? -sys.anim : sys.anim;
                ctx.strokeStyle = "#fff";
                ctx.beginPath();
                ctx.moveTo(300, solY + 50);
                ctx.lineTo(300, valveY - 60);
                ctx.lineTo(190, valveY - 60);
                ctx.lineTo(190, valveY - 50);
                ctx.stroke();
                ctx.setLineDash([]);
            }


            // Mangueras El√©ctricas
            ctx.strokeStyle = "#555";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(batX + 60, modY + 25);
            ctx.lineTo(ctrlX, modY + 25);
            ctx.stroke(); // Bater√≠a a Pegasus

            ctx.beginPath();
            ctx.moveTo(ctrlX + 110, modY + 25);
            ctx.lineTo(solX, modY + 25);
            ctx.stroke(); // Pegasus a Solenoides

            // Bloque BATER√çA
            drawBox(batX, modY, 60, 50, "BATER√çA", "#1565C0");
            // Indicador de Nivel de Bater√≠a
            ctx.fillStyle = "#eee";
            ctx.fillRect(batX + 20, modY + 15, 20, 12);
            ctx.fillRect(batX + 40, modY + 18, 3, 6);
            // Nivel de carga
            let batColor = sys.batteryLevel > 20 ? "#00E676" : (sys.batteryLevel > 5 ? "#FFC107" : "#F44336");
            let batWidth = Math.max(2, sys.batteryLevel * 0.18); // 18 pixeles max

            ctx.fillStyle = batColor;
            ctx.fillRect(batX + 21, modY + 17, batWidth, 8);

            ctx.fillStyle = "#fff";
            ctx.font = "8px Arial";

            ctx.fillText(`${Math.round(sys.batteryLevel)} %`, batX + 12, modY + 40);

            // Bloque PEGASUS (Controlador)
            drawBox(ctrlX, ctrlY, 110, 70, "PEGASUS", "#0D47A1");
            ctx.fillStyle = "#000";
            ctx.fillRect(ctrlX + 5, ctrlY + 12, 100, 42);

            // Valores de datos en pantalla de Pegasus
            ctx.font = "9px monospace";
            ctx.fillStyle = "#00E676";

            ctx.fillText(`In: ${Math.round(sys.pIn)}m`, ctrlX + 8, ctrlY + 22);
            ctx.fillText(`Out: ${Math.round(sys.pOut)}m`, ctrlX + 60, ctrlY + 22);
            ctx.fillText(`Q: ${sys.simFlow}m3/h`, ctrlX + 8, ctrlY + 34);

            ctx.fillStyle = "#4fc3f7";
            ctx.fillText(`SET: ${Math.round(sys.pTarget)}m`, ctrlX + 8, ctrlY + 46);

            // Indicador de Se√±al de Comunicaci√≥n
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(ctrlX + 55, ctrlY);
            ctx.lineTo(ctrlX + 55, ctrlY - 25);
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(ctrlX + 55, ctrlY - 27, 3, 0, Math.PI * 2);
            ctx.fill();
            let commColor = sys.commSignal > 3 ? "#00E676" : (sys.commSignal > 1 ? "#FFC107" : "#F44336");
            ctx.strokeStyle = commColor;
            for (let i = 0; i < sys.commSignal; i++) {
                ctx.beginPath();
                ctx.arc(ctrlX + 55, ctrlY - 27, 8 + i * 4, -Math.PI, 0);
                ctx.stroke();
            }

            // Bloque SOLENOIDES
            drawBox(solX, solY, 70, 50, "SOLENOIDES", "#1976D2");
            const sx = solX + 25;
            const sy = solY + 15;
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 1;
            // Indicador de Pulso de Solenoide
            if (sys.action === 'open') ctx.fillStyle = "#00E676"; // Abrir (Activar)
            else if (sys.action === 'close') ctx.fillStyle = "#FF1744"; // Cerrar (Desactivar/Ventar)
            else ctx.fillStyle = "#333";
            ctx.fillRect(sx, sy, 16, 14);

            ctx.strokeStyle = "#eee";
            ctx.beginPath();
            ctx.moveTo(sx - 4, sy + 14);
            ctx.lineTo(sx + 20, sy + 14);
            ctx.lineTo(sx + 8, sy + 22);
            ctx.closePath();
            ctx.fill();


            drawFitting(135, ctrlY + 70, "#ff1744"); // Toma Pin en Pegasus
            drawFitting(195, ctrlY + 70, "#2979ff"); // Toma Pout en Pegasus
            drawFitting(solX, solY + 25, "#ff1744"); // Suministro Pin a Solenoides
            drawFitting(300, solY + 50, "#00E676"); // L√≠nea de Control
            drawFitting(340, solY + 30, "#555"); // Escape/Venteo
            ctx.fillStyle = "#333";
            ctx.fillRect(342, solY + 25, 10, 10); // Tapa del venteo

            // V√°stago y Diafragma
            ctx.fillStyle = "#d32f2f";
            ctx.fillRect(cx - 6, currentY, 12, (closedY + 20) - currentY); // V√°stago

            // Animaci√≥n de Part√≠culas (Flujo)
            ctx.fillStyle = "rgba(255,255,255,0.5)";
            particles.forEach(p => {
                if (p.x > 360) {
                    p.x = 0;
                    p.y = valveY + 10 + Math.random() * (pipeH - 20);
                }
                let v = 2; // Velocidad de flujo base
                if (p.x > cx - 40 && p.x < cx + 40) {
                    v = sys.valvePos * 6; // Aumentar velocidad en la restricci√≥n
                    if (sys.valvePos < 0.05) v = 0.5; // Flujo m√≠nimo
                }
                p.x += v;
                if (p.y < valveY || p.y > valveY + pipeH) p.y = valveY + 10 + Math.random() * (pipeH - 20);
                ctx.beginPath();
                ctx.arc(p.x, p.y, 2, 0, 6.28);
                ctx.fill();
            });

            // Animaci√≥n de Fuga/Roc√≠o (Spray)
            if (sys.action === 'open' && !sys.failOpen) {
                ctx.fillStyle = "cyan";
                spray.forEach(p => {
                    ctx.globalAlpha = p.life;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 2, 0, 6.28);
                    ctx.fill();
                });
                ctx.globalAlpha = 1;
            }
        }

        // --- Funciones Auxiliares de Dibujo ---

        function drawBox(x, y, w, h, t, c) {
            ctx.fillStyle = c;
            ctx.strokeStyle = "#81d4fa";
            ctx.lineWidth = 1;
            ctx.fillRect(x, y, w, h);
            ctx.strokeRect(x, y, w, h);
            ctx.fillStyle = "#fff";
            ctx.font = "9px Arial";
            ctx.fillText(t, x + 5, y + h - 5);
        }

        function drawFitting(x, y, color) {
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 1;
            ctx.stroke();
        }

        function drawSpring(x, y1, y2) {
            ctx.strokeStyle = "#cfd8dc";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x, y1);
            let step = (y2 - y1) / 6;
            for (let i = 0; i < 6; i++) {
                let cy = y1 + i * step;
                ctx.lineTo(x - 15, cy + step * 0.25);
                ctx.lineTo(x + 15, cy + step * 0.75);
                ctx.lineTo(x, cy + step);
            }
            ctx.stroke();
        }


        // --- Bucle Principal ---
        function loop() {
            updateSystemLogic();
            drawTimeline();
            drawSchematic();
            requestAnimationFrame(loop);
        }

        // Inicializaci√≥n
        resize();
        updateControlsState();
        loop();
    </script>
</body>

</html>